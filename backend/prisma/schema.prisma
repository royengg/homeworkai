generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  userId    Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  uploads   Upload[]
}

enum UploadStatus {
  uploading   
  uploaded    
  processing 
  processed  
  failed      
}

model Upload {  
  uploadId    String        @id @default(uuid())

  user        User         @relation(fields: [userId], references: [userId])
  userId      Int

  bucket      String
  key         String

  size        Int?          
  mime        String?
  etag        String?
  checksum    String?       

  status      UploadStatus  @default(uploading)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  confirmedAt DateTime?
  processedAt DateTime?
  error       String?       
  parseResult ParseResult? 
  analyses    AnalysisResult[]

  @@unique([bucket, key])  
  @@index([userId])
}

model ParseResult {
  id        String  @id @default(uuid())

  upload    Upload  @relation(fields: [uploadId], references: [uploadId], onDelete: Cascade)
  uploadId  String  @unique

  text      String  
  numPages  Int?
  createdAt DateTime @default(now())
}

enum AnalysisStatus {
  queued
  running
  completed
  failed
}

model AnalysisResult {
  id        String  @id @default(uuid())
 
  upload    Upload  @relation(fields: [uploadId], references: [uploadId], onDelete: Cascade)
  uploadId  String
 
  prompt    String?
  model     String?

  status    AnalysisStatus @default(completed)
  error     String?
  
  output    Json

  usagePromptTokens     Int?
  usageCompletionTokens Int?
  usageTotalTokens      Int?

  solutionBucket String?
  solutionKey    String?
  pages          Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([uploadId])
  @@index([createdAt])
}
